## Buliding Microservices 第二章笔记

这章的名字叫 The Evolutionary Architect。意思就是不断进化的架构师。主要讲的是架构师这个角色是做什么的，架构师应该如何去不断进化，以适应最新的情况。因为软件会不断进化，就和一个有机体一样。

### Inaccurate Comparisons

作者首先对架构师这个 title 批判了一番。在建筑行业，建筑师这个 title 是需要长时间的学习的，而且建筑行业有几千年的经验积累，建筑师会有很多社会责任。而软件行业有点急功近利的用了架构师这个词，其实是对大家的一种伤害。因为软件行业的架构师，不会承担那么多责任。软件行业也太年轻，我们还不知道最佳的软件是怎样的。所以最好的办法是，把软件的架构师和建筑师两个词，当作不同的词来看。Redefine what architect means in our context。

### An Evolutionary Vision for the Architect

软件和建筑不一样，软件一旦交付到用户手里，就需要不断进化，去满足用户的需求。城市和软件很像，很多人都把城市比作是一个有生命的实体。所以作者提出，相比建筑师，软件架构师的角色更接近于一个城市规划师。他的作用就是规划/优化城市的各个区域。

城市架构师不会控制一切，不会参与过多细节，他要做的就是有人在居民区造污水厂的时候，阻止他。架构师不仅要保证居民——也就是用户可以在城市中快乐的生活，同时也要保证这个城市（软件）对开发者和运维人员来说也是宜居的。其实也就是说，架构设计也要考虑到如何让大家更有效率的开发和运维这个系统。

### Zoning

在城市规划中的分区，在微服务设计中，就是指服务和服务直接的边界（boundaries）或者说是粗粒度的服务划分。我们关心的是服务和服务之间如何通信。

虽然微服务是自治的，但是如果每个服务都选择了不同的数据库、技术栈、或者通信接口（REST/RPC），那我们就需要花很大的成本去研究每一种数据库的高可用方案，或者在一个服务中同时支持REST和RPC风格的接口。这样的代价是很大的。架构师要做的就是把这些服务之间发生的事情给规划好。

要保证架构对于开发者是宜居的，架构师要定期和开发团队坐在一起，才能真正的体验到痛点

### A Principed Approach

微服务架构设计其实就是各种 trade-offs。我们需要一个框架去引导我们做决定。这个框架由几部分组成：

+ Stategic Goals
+ Principles
+ Practices

战略目标一般是公司层面的，非技术的，比如拓展东南亚市场。这些一般不用架构师来制定。

Principles 一般是配合战术层面的。比如公司需要拓展多个市场，那你的服务可能就需要交给当地的政府部署，从这个角度来说，你的服务需要有单独部署的能力。Principles 不应该超过10条，否则就容易相互矛盾。Heroku 的12 Factors
 就是一个不错的参考。

Practices 是 Principles的具体实现，不过这两者是相对的，没有那么明显的界限。

作者还给出了一个框架的例子，我们在自己的架构设计中也可以画一个类似的图。

![](http://wx4.sinaimg.cn/large/64c45edcgy1fr0acez3hwj215t0v1jwl.jpg)


### The Required Standard

虽然微服务是自治的，有多样性，但是我们需要有一个“黄金标准”，来描述一个好的微服务的形态。比如监控，我们需要有统一的上报方式。通信，我们需要有统一的协议，在统一的协议基础上，我们还需要仔细的规范，比如HTTP/REST方面，我们就需要规定资源分页的规范、URL中名词或者动词的规范。最后我们要注意架构中的一些规范，比如HTTP状态码和RPC调用的成功与否，这些信息可以让我们及时得知别的服务发生问题，以便利用熔断机制避免发生问题的服务波及整个系统。

### Governance Through Code

这节主要讲的是利用示例（Examplars）和订制的服务模板（Tailored Service Template）来在代码层面管理/限制微服务的风格，让微服务的标准可以得到推行。

如果团队的不同服务的技术栈差异很大，那就需要去协作实现一个跨语言的基础服务。比如 Netflix 的 sidecar services。

### Technical Debt

技术债形成的原因主要是，技术视野和紧急业务需求直接存在矛盾。有时候为了按期把业务上线，我们需要欠下一些技术债。有时候我们的技术视野会升级，这样也造成之前的架构需要调整。架构师的职责是从整体出发，为开发团队提供引导，让他们选择合适的时机去还上技术债。

### Exception Handling

见书 P24

### Governance and Leading from the Center

作者建议应该建立一个以架构师为负责人的管理小组。架构师一般情况下都应该听取小组的集体意见。但如果架构师发现团队正走向错误的决定，他就应该阻止。小组成员如果被否定，会决定自己的意见得不到表达。所以架构师的这个决定是要经过谨慎的抉择的。

### Building a Team

架构师不仅仅要关心技术，也要去帮助团队成员了解自己的视野，帮助他们成长。让团队成员成为技术视野形成和实现的关键成员。毕竟这些团队成员才是真正去实现架构师想法的人。

相比 monolithic 的应用来说，微服务这个架构可以让团队成员变成自己负责的服务的 Owner。这是微服务架构的又一个好处。
