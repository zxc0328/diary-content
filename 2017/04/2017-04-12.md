## Linux System Programming 读书笔记

### 第二章

第二章主要讲的是文件I/O。因为Unix里有一个理念就是**万物都是文件**，所以文件I/O也不仅仅是用在文件的读写上，比如socket和pipe等等的读写也是用文件I/O的API。因此这块内容是一个重点。

API的使用的话，还是比较简单清晰的。引起我注意的有几点：

首先是错误处理，不过这个不仅仅是文件相关的，这是Unix上通用的错误处理方式。具体来说就是API在发生错误时会返回-1，然后**错误号会存在一个叫`errno`的全局变量里面**。根据这个错误号，可以查表得知错误原因的字符串。这里需要注意的是这个错误变量是全局公用的，因此有时需要将其的值保存到临时变量里，以避免被其他发生错误的API修改。

然后是文件的缓存。`write`这个API，**会将写入的内容存在内核的buffer里，然后立刻返回。然后操作系统会在合适的时刻把这个buffer写到磁盘里。这种机制叫write back。**具体的实现涉及内核具体的设计（其实学校里讲操作系统就会讲到这些，但只是一个抽象的算法描述）。大致就是，内存的page是磁盘的映像，两者会进行同步。之所以这样设计其实很简单，和计算机系统里所有的缓存存在的道理是一样的，就是局部性原理。

这里比较巧妙的就是。如果你用`write`写入了数据，然后立即调用`read`读取文件，如果这个时候内核的buffer还没有同步到磁盘，那`read`会直接从内核的buffer里面读取最新的数据。

所以这一层缓存对于API调用者是不可见的。我也是看了书才知道平时用的I/O其实被缓存了。